---
output: github_document
---

<!-- README.md is generated from README.Rmd. Please edit that file -->

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  fig.path = "man/figures/README-",
  out.width = "100%"
)
```

# econanalyzr

<!-- badges: start -->
<!-- badges: end -->

The goal of econanalyzr is to provide a collection of functions and helper 
datasets that help users obtain, analyze, and visualize economic data. These
functions can be broken up into **data import** functions, **data analysis**
functions, and **data visualization** functions.

These are some of the most commonly used functions currently available: 

* `get_bls_data()` which is a wrapper that sends HTTP requests to the BLS site with a valid user-supplied email to download TSV data from their flat file database.
* `percent_change()` which calculates the percentage change between two numeric scalars or vectors
* `annualize_change()` which calculate the annualized rate of change between two numeric scalars or vectors for a given time period.
* `create_index()` which calculates a 0 or 100-based index version of a numeric vector based on the starting value supplied.
* `create_diffusion_index()` which calculates a diffusion index for two numeric scalars or vectors based on the [Federal Reserve](https://www.richmondfed.org/-/media/richmondfedorg/publications/research/economic_quarterly/2004/fall/pdf/harrisowenssarte.pdf) or [IHS Markit](https://cdn.ihsmarkit.com/www/pdf/1218/IHS-Markit-PMI-Introduction.pdf) methods or one numeric scalar or vector based on the [Conference Board](https://www.conference-board.org/data/bci/index.cfm?id=2180) method.

## Installation

You can install the development version of econanalyzr from [GitHub](https://github.com/) with:

``` r
# install.packages("pak")
pak::pak("anesta95/econanalyzr")
```

## Data Import Examples
Use the `get_bls_data()` function to get TSV data from the BLS survey flat file
database. This function will require you to provide a valid email in the request
`user-agent` which is now required to programmatically obtain BLS data in this way.
```{r get_bls_data example}
library(econanalyzr)
bls_jolts <- get_bls_data(
  bls_url = "https://download.bls.gov/pub/time.series/jt/jt.data.1.AllItems", 
  email = "govdata.decimeter618@passmail.net"
  )

str(bls_jolts)
```


## Data Analysis Examples
Use the `percent_change()` function to calculate the percentage change 
between two numeric scalars and vectors:

```{r percent_change example}
library(econanalyzr)
# Scalar → scalar
percent_change(100, 120)

# Vectorized (pairwise)
percent_change(c(100, 80, 50), c(110, 72, 55))

# Scalar recycling (start is scalar)
percent_change(100, c(101, 105, 120))

# NA propagates (emits a classed warning)
percent_change(c(100, NA), c(110, 120))

# Division by zero yields NA (with a single classed warning)
percent_change(c(0, 10), c(5, 15))

```

Use the `annualize_change()` function to calculate the annualized
_one month_ change between two numeric vectors of values:

```{r annualize_change example}
library(econanalyzr)

# Monthly: from 100 to 103 over 1 month (12 months/year)
annualize_change(100, 103, time_elapsed = 1, time_unit = "monthly")

# Vectorized, scalar recycling (quarterly): exponent = 4 / time_elapsed
annualize_change(
  start_values = 100,
  end_values   = c(101, 98, 120),
  time_elapsed = 2,
  time_unit    = "quarterly"
)

# Daily with default Gregorian year_length = 365.2425
annualize_change(100, 101, time_elapsed = 10, time_unit = "daily")

# Weekly using exact 52-week convention (364 days)
annualize_change(100, 101, time_elapsed = 2, time_unit = "weekly", year_length = 364)

```

Use the `create_index()` to transform a vector of numeric values into a 0 or 100
based index:

```{r create_index example}
library(econanalyzr)

# Base-100 index (default): base is the first element (50 -> 100)
create_index(c(50, 100, 150))

# Percent-change index (idx_type = 0): base becomes 0%
create_index(c(90, 100, 120), idx_pos = 2, idx_type = 0)

# Select base by *name* (only if the vector is named)
x <- c("2023-01" = 80, "2023-02" = 100, "2023-03" = 120)
create_index(x, idx_pos = "2023-02")            # base-100 with named base

create_index(x, idx_pos = "2023-02", idx_type = 0)  # percent change from "2023-02"

# Non-base NA/NaN/Inf values warn once and propagate
y <- c(100, NA, 200)
create_index(y, idx_pos = 1)
```

Use the `create_diffusion_index()` to calculate a Federal Reserve or IHS diffusion index from numeric values
of percent increase, percent unchanged, or percent decreasing or a Conference Board diffusion index from percent
change values.

```{r create_diffusion_index example}
library(econanalyzr)

# Federal Reserve method: (pct_increased − pct_decreased) * 100
create_diffusion_index(
  pct_increased = c(0.60, 0.55, 0.40),
  pct_decreased = c(0.20, 0.25, 0.35),
  idx_type      = "Federal Reserve"
)

# Scalar recycling with FR (scalar increased, vector decreased)
create_diffusion_index(
  pct_increased = 0.50,
  pct_decreased = c(0.20, 0.25, 0.35),
  idx_type      = "Federal Reserve"
)

# IHS-PMI method: (pct_increased + 0.5 * pct_unchanged) * 100
create_diffusion_index(
  pct_increased = c(0.55, 0.50),
  pct_unchanged = c(0.30, 0.35),
  idx_type      = "IHS-PMI"
)

# Conference Board method (threshold ±0.05%): encode and average
pc <- c(+0.0010, +0.0005, 0.0000, -0.0005, -0.0020)
create_diffusion_index(pct_change = pc, idx_type = "Conference Board")

# Conference Board with NA: NA are dropped from the mean (warns once)
create_diffusion_index(pct_change = c(0.001, NA, -0.001), idx_type = "Conference Board")


# All NA example returns NA (single, specific warning)
create_diffusion_index(pct_change = c(NA_real_, NA_real_), idx_type = "Conference Board")

```

## `econanalyzr` Tibble Structure and Functions

Every econ analysis data CSV file at minimum will have the following columns:

- `date`: The date associated with the data in the data row. The date will be in `YYYY-MM-DD` format regardless of the time period the date captures. All dates will be the first day of the time period. For example, data for April 2025 will be displayed as `2025-04-01`. Data for Q2 2025 will be `2025-04-01`. Data for the year 2025 will be `2025-01-01`. This will have a data type `double` with a class of `Date`.

- `date_period_text`: The time period that each row of the data captures. The most common formats are `Monthly`, `Quarterly`, and `Annually`. This will have a data type and class of `character`.
- `value`: The value that is being measured in the data. This will have a data type of `double` and a class of `numeric`.
- `data_element_text`: What the data in the `value` column describes. This will have a data type and class of `character`.
- `data_measure_text`: The mathematical expression the data in the `value` column is expressed as. The most common are `Level`, `Rate`, `Ratio`, `Percentage`, `Proportion`, and `Index`. This will have a data type and class of `character`.
- `date_measure_text`: The change in dates measured by the data in the `value` column. The most common are `Current`, `Year-over-year`, `Month-over-month` and `Quarter-over-quarter`. This will have a data type and class of `character`.
- `data_transform_text`: Any mathematical transformations applied to the data. The most common are `Raw`, `Percent change`, `Annualized`, `Trail N` where `N` is a number of periods in the `date_period_text` column. There can be multiple transformations for each row. Transformations are delimited by semi-colons `;` and are stated _in order of transformation_. For example, `Trail 3;Percent change` will be the percentage change between the trailing 3 period average of the current period — denoted in the `date` column — and the trailing 3 period average of the previous period which is deduced from the `date_measure_text`. Conversely, `Percent change;Trail 3` will be the trailing 3 period average applied to the percentage change between the current period and the previous period across the data series. This will have a data type and class of `character`.
- `geo_entity_type_text`: The geographic entity _type_ the data in the `value` column is covering. This will have a data type and class of `character`. If the region is in the United States there is a good chance it will be within the [Census Bureau Geographic Entity Hierarchy](https://www2.census.gov/geo/pdfs/reference/geodiagram.pdf).
- `geo_entity_text`: The name(s) geographic entity/entities that are described by the data.
- `viz_type_text`: The type of visualization made by the data in the `value` column. The most common are `Time series line`, `Bar`, `Map`, and `Scatter`. This will have a data type and class of `character`.

### Naming conventions
Both CSVs and PNGs are named with the following format where each aspect of the 
data is delimited with a dash `-` and spaces are replaced with underscores `_`.

Data and visualization files will be named in the following order:

1. `date`
2. `date_period_text`
3. `data_element_text`
4. `data_measure_text`
5. `date_measure_text`
6. `data_transform_text`
7. `geo_entity_type_text`
8. `geo_entity_text`
9. _Any other aspects of the data specific to the release that are needed to uniquely identify it._ Examples include `industry_text`, `size_class_text`, `seas_adj_text`, among others.
10. `viz_type_text`

For data file and chart names with multiple dates in the `date` field — such as files with a the `viz_type_text` of `Time series line` — the `date` file naming convention will have the most and least recent dates in the data series.

#### Examples
* CSV files: 
  * `2025-04-01_2023-04-01-monthly-quits-rate-current-2_data_transform-nation-us-total_nonfarm-all_size_classes-seasonally_adjusted-time_series_line.csv`
  * `2025-04-01-monthly-job_openings-rate-year-over-year-trail_3_percent_change-nation-us-12_industry-all_size_classes-seasonally_adjusted-bar.csv`
* PNG files: 
  * `2025-04-01_2023-04-01-monthly-quits-rate-current-2_data_transform-nation-us-total_nonfarm-all_size_classes-seasonally_adjusted-time_series_line.png`
  * `2025-04-01-monthly-job_openings-rate-year-over-year-trail_3_percent_change-nation-us-12_industry-all_size_classes-seasonally_adjusted-bar.png`

Every column in the dataset with the `_text` suffix will be included in the filename, in addition to the `date` column. Data files will also include columns that have further information that is _not_ needed to uniquely identify the data series. Examples of this include the `value` column, variables with the `_code` suffix such as `industry_code`, `fips_code`,`preliminary_code`, as well as `moe`, and `moe_level`, among others.

## Functions

`econ_value_summary()` filters an econanalyzr-valid data frame by either a set of dates or a closed date range, pulls a numeric column (defaults to "value"), and applies a user-supplied function to the filtered vector.

```{r}
library(econanalyzr)

# Minimal econanalyzr-valid example data
df <- tibble::tibble(
  date                 = seq(as.Date("2025-01-01"), by = "month", length.out = 6),
  date_period_text     = "Monthly",
  value                = c(100, 105, 103, 108, 112, 115),  # numeric (double)
  data_element_text    = "Quits Rate",
  data_measure_text    = "Percent",
  date_measure_text    = "Monthly",
  data_transform_text  = "SA",
  geo_entity_type_text = "Nation",
  geo_entity_text      = "US",
  viz_type_text        = "Line"
)

# 1) Inclusive set of dates: mean(value) on Feb & May 2025
econanalyzr::econ_value_summary(
  df,
  dates       = as.Date(c("2025-02-01", "2025-05-01")),
  filter_type = "inclusive",
  .fun        = mean,          # any function or function name is fine
  na_rm       = TRUE           # drop NAs before calling .fun
)

# 2) Exclusive closed range: median(value) with Jan–Mar 2025 dropped
econanalyzr::econ_value_summary(
  df,
  date_range  = as.Date(c("2025-01-01", "2025-03-31")),
  filter_type = "exclusive",   # drop rows in the range
  .fun        = median
)

# 3) Vector-returning function: quantiles over all dates
econanalyzr::econ_value_summary(
  df,
  .fun = function(x) stats::quantile(x, c(.25, .5, .75))  # returns a numeric vector
)
```

`econ_calc_trail_avg()` computes a right-aligned trailing average of `value` based on a user-specified window and appends those rows to your `econanalyzr` tibble in long form. Incomplete windows produce `NA`, and `; Trail {n}` is appended to the `data_transform_text` field where `n` is the length of the window.

```{r}
library(econanalyzr)

# Minimal econanalyzr-valid data (one series)
df <- tibble::tibble(
  date                 = seq(as.Date("2025-01-01"), by = "month", length.out = 6),
  date_period_text     = "Monthly",
  value                = c(100, 105, 103, 108, 112, 115),  # double
  data_element_text    = "Quits Rate",
  data_measure_text    = "Percent",
  date_measure_text    = "Monthly",
  data_transform_text  = "SA",
  geo_entity_type_text = "Nation",
  geo_entity_text      = "US",
  viz_type_text        = "Line"
)

# Append a 3-period trailing average (right-aligned; first 2 windows are NA)
trail_df <- econanalyzr::econ_calc_trail_avg(df, trail_amount = 3)
# Trailing-average rows are appended; identify them by the suffix in data_transform_text
dplyr::filter(trail_df, grepl("; Trail 3$", data_transform_text)) |>
  dplyr::select(date, value, data_transform_text)

# --- Grouped example: compute trailing average within each series ----------------

df_g <- tibble::tibble(
  date                 = rep(seq(as.Date("2025-01-01"), by = "month", length.out = 5), each = 2),
  date_period_text     = "Monthly",
  value                = as.double(c(100, 200, 105, 210, 103, 220, 108, 230, 112, 240)),
  data_element_text    = "Quits Rate",
  data_measure_text    = "Percent",
  date_measure_text    = "Monthly",
  data_transform_text  = "SA",
  geo_entity_type_text = "Nation",
  geo_entity_text      = rep(c("US","CA"), times = 5),
  viz_type_text        = "Line"
)

out_g <- df_g |>
  dplyr::group_by(geo_entity_text) |>
  econanalyzr::econ_calc_trail_avg(3)

# Show trailing-average rows per country (suffix identifies derived rows)
dplyr::filter(out_g, grepl("; Trail 3$", data_transform_text)) |>
  dplyr::select(geo_entity_text, date, value, data_transform_text) |>
  dplyr::arrange(geo_entity_text, date)
#> Each country's trailing means are computed independently within its group.

```

`econ_filter_dates()` filters an econanalyzr-valid data frame to a closed date interval `[start_date, end_date]`. If `start_date` is omitted, you can specify a period (`period_type` + `period_amount`) and it derives `start_date = end_date − period` (with `end_date` defaulting to the latest non-NA date). Returns rows inclusive of the bounds and ordered newest-first.

```{r}
library(econanalyzr)

# Minimal econanalyzr-valid table (10 monthly points)
df <- tibble::tibble(
  date                 = seq(as.Date("2024-09-01"), by = "month", length.out = 10),
  date_period_text     = "Monthly",
  value                = as.double(1:10 * 10),
  data_element_text    = "Quits Rate",
  data_measure_text    = "Percent",
  date_measure_text    = "Monthly",
  data_transform_text  = "SA",
  geo_entity_type_text = "Nation",
  geo_entity_text      = "US",
  viz_type_text        = "Line"
)

# 1) Last 4 months ending at the table’s latest date (derives start_date)
last4 <- econanalyzr::econ_filter_dates(
  df, period_type = "months", period_amount = 4
)
dplyr::select(last4, date, value)


# 2) Between explicit dates (inclusive)
rng <- econanalyzr::econ_filter_dates(
  df,
  start_date = as.Date("2025-02-01"),
  end_date   = as.Date("2025-06-01")
)
dplyr::select(rng, date, value)
```

`econ_csv_write_out()` validates an econanalyzr data frame and writes it to CSV using a descriptive filename built from the date span and all *_text columns.

```{r}
library(econanalyzr)

# Minimal econanalyzr-valid tibble
df <- tibble::tibble(
  date                 = seq(as.Date("2025-01-01"), by = "month", length.out = 6),
  date_period_text     = "Monthly",
  value                = c(100, 105, 103, 108, 112, 115),
  data_element_text    = "Quits Rate",
  data_measure_text    = "Percent",
  date_measure_text    = "Monthly",
  data_transform_text  = "SA",
  geo_entity_type_text = "Nation",
  geo_entity_text      = "US",
  viz_type_text        = "Line"
)

# Write to a temporary folder with a descriptive, sanitized filename
outdir <- tempdir()
path <- econanalyzr::econ_csv_write_out(df, folder = outdir, overwrite = TRUE)

basename(path)

file.exists(path)
```


## Data Visualization Examples

Economic `{ggplot2}` data visualization templates to come!


